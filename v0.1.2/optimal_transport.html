<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Optimal transport · UnbalancedOptimalTransport.jl</title><link rel="canonical" href="https://ericphanson.github.io/UnbalancedOptimalTransport.jl/optimal_transport.html"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">UnbalancedOptimalTransport.jl</span></div><form class="docs-search" action="search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="index.html">Home</a></li><li class="is-active"><a class="tocitem" href="optimal_transport.html">Optimal transport</a><ul class="internal"><li><a class="tocitem" href="#Entropic-regularization-1"><span>Entropic regularization</span></a></li><li><a class="tocitem" href="#Dual-potentials-1"><span>Dual potentials</span></a></li><li><a class="tocitem" href="#References-1"><span>References</span></a></li></ul></li><li><a class="tocitem" href="public_api.html">Public API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="optimal_transport.html">Optimal transport</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="optimal_transport.html">Optimal transport</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/ericphanson/UnbalancedOptimalTransport.jl/blob/master/docs/src/optimal_transport.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Optimal-transport-1"><a class="docs-heading-anchor" href="#Optimal-transport-1">Optimal transport</a><a class="docs-heading-anchor-permalink" href="#Optimal-transport-1" title="Permalink"></a></h1><p>Optimal transport is a theory that provides a way to describe distances between positive measures in terms of distances on their underlying domains. The following is a short description of the task; for a more thorough review, see <a href="https://en.wikipedia.org/wiki/Transportation_theory_(mathematics)">Wikipedia</a>, or some of the <a href="optimal_transport.html#Other-references-1">Other references</a>.</p><p>In this package, we only consider finite sets, and so a &quot;positive measure&quot; is simply a collection of non-negative numbers. In the case that these numbers sum to one, we can consider them as probabilities, although we don&#39;t make that restriction here. Let <span>$X$</span> and <span>$Y$</span> be finite sets (the only kind considered in this package), and <span>$a$</span> and <span>$b$</span> be functions,</p><div>\[a : X \to \mathbb{R}_+ \quad \text{and} \quad b: Y \to \mathbb{R}_+.\]</div><p>We assume <span>$a(x) &gt; 0$</span> for each <span>$x \in X$</span> and likewise <span>$b(y) &gt; 0$</span> for <span>$y \in Y$</span>; zero elements can simply be removed from <span>$X$</span> or <span>$Y$</span>.</p><p>The associated <em>optimal transport problem</em> is the following. We start with <span>$a(x)$</span> &quot;mass&quot; of material at each point <span>$x \in X$</span>, and wish to end up with <span>$b(y)$</span> mass of material at each point <span>$y \in Y$</span>, but there is some cost <span>$c(x,y)$</span> associated to moving a unit of mass from <span>$x$</span> to <span>$y$</span>.</p><p>For each pair <span>$(x,y) \in X\times Y$</span>, we aim to decide how much mass to move from <span>$x$</span> to <span>$y$</span> by choosing a <em>coupling</em>, a function <span>$π : X \times Y \to \mathbb{R}_+$</span>, which minimizes the cost:</p><div>\[\begin{aligned}
\operatorname{OT}(a,b) := \text{minimize} \quad &amp; \sum_{x\in X, y \in Y} π(x,y) c(x,y)\\
\text{such that} \quad &amp; a(x) = \sum_{y \in Y} \pi(x,y) \quad \forall x \in X\\
&amp; b(y) = \sum_{x \in X} \pi(x,y) \quad, \forall y \in Y\\
&amp; \pi(x,y) \geq 0 \quad \forall x\in X,\, \forall y \in Y.
\end{aligned}\]</div><p>The constraint <span>$a(x) = \sum_{y \in Y} \pi(x,y)$</span> means that <span>$a(x)$</span> units of mass was transported from location <span>$x$</span>, and <span>$b(y) = \sum_{x \in X} \pi(x,y)$</span> means that <span>$b(y)$</span> units of mass ended up at location <span>$y$</span>, as desired.</p><p>The problem as written, however, has no solution (is <em>infeasible</em>), however, if <span>$\sum_{x\in X} a(x) \neq \sum_{y \in Y}b(y)$</span>, as can be verified by the fact that if a solution <span>$\pi$</span> existed, then the constraints imply that</p><div>\[\sum_{y \in Y} b(y) = \sum_{x\in X, y \in Y} \pi(x,y) = \sum_{x \in X} a(x).\]</div><p>which is a contradiction. That&#39;s because our problem as posed does not allow the creation or destruction of mass.</p><p>To resolve this, following [<a href="optimal_transport.html#SFVTP19-1">SFVTP19</a>], we remove the requirements that <span>$a(x) = \sum_{y \in Y} \pi(x,y)$</span> and <span>$b(y) = \sum_{x \in X} \pi(x,y)$</span>, and instead add a penalty that grows the more those constraints are violated (i.e. imposing &quot;soft&quot; constraints instead of &quot;hard&quot; constraints).</p><p>We model these penalties as a <span>$\varphi$</span>-divergence <span>$D_\varphi$</span>, which are defined in terms of a function <span>$\varphi : \mathbb{R}_+ \to \mathbb{R}_+$</span> as</p><div>\[D_\varphi(u \| v) := \sum_{z \in Z} \varphi( \frac{u(z)}{v(z)} ) b(z)\]</div><p>where <span>$Z$</span> is a finite set, and <span>$u : Z \to \mathbb{R}_+$</span> and <span>$v : Z \to \mathbb{R}_+$</span> as functions with <span>$v(z) &gt; 0$</span> for each <span>$z \in Z$</span>. See <a href="public_api.html#Divergences-1">Divergences</a> for the list of divergences implemented in this package.</p><p>With that modification, we have the <em>unbalanced optimal transport problem</em>,</p><div>\[\begin{aligned}
\operatorname{OT}(D_\varphi, a,b) := \text{minimize} \quad &amp;
\sum_{x\in X, y \in Y} π(x,y) c(x,y) + D_\varphi(\pi_1 \| a) + D_\varphi(\pi_2 \| b)\\
\text{such that} \quad &amp; \pi(x,y) \geq 0 \quad \forall x\in X,\, \forall y \in Y.
\end{aligned}\]</div><p>where <span>$\pi_1$</span> is defined by <span>$\pi_1(x) = \sum_{y \in Y} \pi(x,y)$</span> for each <span>$x \in X$</span>, and likewise <span>$\pi_2(y)=\sum_{x \in X} \pi(x,y)$</span> for <span>$y \in Y$</span>.</p><h2 id="Entropic-regularization-1"><a class="docs-heading-anchor" href="#Entropic-regularization-1">Entropic regularization</a><a class="docs-heading-anchor-permalink" href="#Entropic-regularization-1" title="Permalink"></a></h2><p>We are faced with a problem: <span>$\operatorname{OT}(D_\varphi, a,b)$</span> can be difficult to compute, especially when <span>$X$</span> and <span>$Y$</span> are large. It turns out that <span>$\operatorname{OT}(D_\varphi, a,b)$</span> can be described as the limit of a sequence of problems that are easier to solve.</p><p>For <span>$\varepsilon \geq 0$</span>, consider the <em>entropically-regularized unbalanced optimal transport problem</em>,</p><div>\[\begin{aligned}
\operatorname{OT}(D_\varphi, a,b, \varepsilon) := \text{minimize} \quad &amp;
    \sum_{x\in X, y \in Y} π(x,y) c(x,y) + D_\varphi(\pi_1 \| a)
    + D_\varphi(\pi_2 \| b) + \varepsilon \operatorname{KL}(\pi \| a \otimes b)\\
\text{such that} \quad &amp; \pi(x,y) \geq 0 \quad \forall x\in X,\, \forall y \in Y.
\end{aligned}\]</div><p>where <span>$\operatorname{KL}$</span> is the <em>Kullback Leibler divergence</em> (also called the <em>relative entropy</em>), which in fact is the <span>$\varphi$</span>-divergence with <span>$\varphi(x) = x\log x - x + 1$</span>, and <span>$a \otimes b : X \times Y \to \mathbb{R}_+$</span> is defined by <span>$(a \otimes b)(x,y) := a(x)b(y)$</span>.</p><p>Entropic regularization refers to the additional term <span>$\varepsilon \operatorname{KL}(\pi \| a \otimes b)$</span>. Adding this term yields several advantages; see e.g. Chapter 4 of [PC18] in <a href="optimal_transport.html#Other-references-1">Other references</a> for entropic regularization in optimal transport in general, and [<a href="optimal_transport.html#SFVTP19-1">SFVTP19</a>] in particular for the unbalanced case. As concerns this package, however, the most important advantage is that <span>$\operatorname{OT}(D_\varphi, a,b, \varepsilon)$</span> can be computed quickly by an iterative scheme called <em>Sinkhorn&#39;s algorithm</em>, which is implemented in the function <a href="public_api.html#UnbalancedOptimalTransport.unbalanced_sinkhorn!"><code>unbalanced_sinkhorn!</code></a>, based on Algorithm 1 of [<a href="optimal_transport.html#SFVTP19-1">SFVTP19</a>]. This is used to compute the quantity <span>$\operatorname{OT}(D_\varphi, a,b, \varepsilon)$</span> in the function <a href="public_api.html#UnbalancedOptimalTransport.OT!"><code>OT!</code></a>.</p><p>Note that this package also implements the optimization problem form of <span>$\operatorname{OT}(D_\varphi, a, b, \varepsilon)$</span>, using the modelling language <a href="https://github.com/JuliaOpt/Convex.jl">Convex.jl</a> and the solvers <a href="https://github.com/JuliaOpt/SCS.jl">SCS.jl</a> and <a href="https://github.com/JuliaOpt/ECOS.jl">ECOS.jl</a>, in <code>test/Convex_formulation.jl</code>, in order to test the implementation of Sinkhorn&#39;s algorithm in <a href="public_api.html#UnbalancedOptimalTransport.unbalanced_sinkhorn!"><code>unbalanced_sinkhorn!</code></a>. This functionality is contained in the tests rather than the package itself in order to avoid the extra dependencies, and since solving the optimization problem is much less practical than using Sinkhorn&#39;s algorithm.</p><p>One problem raised by the regularization is that</p><div>\[\operatorname{OT}(D_\varphi,a,a,\varepsilon) \neq 0\]</div><p>in general. This is not ideal when one wishes to consider <span>$(a,b) \mapsto \operatorname{OT}(D_\varphi,a,b,\varepsilon)$</span> as a measure of distance between <span>$a$</span> and <span>$b$</span>. To remedy this, one defines the <em>Sinkhorn divergence</em></p><div>\[S(D_\varphi,a,b,\varepsilon) := \operatorname{OT}(D_\varphi,a,b,\varepsilon)
    - \frac{1}{2}\operatorname{OT}(D_\varphi,a,a,\varepsilon)
    - \frac{1}{2}\operatorname{OT}(D_\varphi,b, b,\varepsilon)
    + \frac{\epsilon}{2}(m(a) - m(b))^2\]</div><p>where e.g. <span>$m(a) = \sum_{x\in X} a(x)$</span> is the total mass of <span>$a$</span> (this is Def. 6 of [<a href="optimal_transport.html#SFVTP19-1">SFVTP19</a>]). This quantity is computed by <a href="public_api.html#UnbalancedOptimalTransport.sinkhorn_divergence!"><code>sinkhorn_divergence!</code></a>.</p><p>When <span>$D_\varphi$</span> is chosen as proportional to <span>$\operatorname{KL}$</span>, this quantity has the following useful properties, shown in Theorem 4 of [<a href="optimal_transport.html#SFVTP19-1">SFVTP19</a>]:</p><ul><li>Positive-definiteness: <span>$S(D_\varphi,a,b,\varepsilon) \geq 0$</span> with equality if and only if <span>$a=b$</span></li><li>Convexity in both arguments: <span>$a \mapsto S(D_\varphi,a,b,\varepsilon)$</span> is convex, and <span>$b \mapsto S(D_\varphi,a,b,\varepsilon)$</span> is convex.</li></ul><h2 id="Dual-potentials-1"><a class="docs-heading-anchor" href="#Dual-potentials-1">Dual potentials</a><a class="docs-heading-anchor-permalink" href="#Dual-potentials-1" title="Permalink"></a></h2><p>The quantity <span>$\operatorname{OT}(D_\varphi, a,b, \varepsilon)$</span> can be equivalently described by the so-called <em>dual problem</em>,</p><div>\[\begin{aligned}
\operatorname{OT}(D_\varphi, a,b, \varepsilon) = \text{maximize} \quad
&amp; -\sum_{x\in X} a(x) \varphi^*(-f(x)) -\sum_{y\in Y} b(y) \varphi^*(-g(x))\\
    &amp; \quad - \varepsilon \sum_{x\in X, y \in Y} a(x)b(y)
    \left(\exp( \frac{f(x) + g(y) - c(x,y)}{\varepsilon} ) -1\right) \\
\text{where} \quad &amp; f : X \to \mathbb{R}, \, g : Y \to \mathbb{R}
\end{aligned}\]</div><p>where <span>$\varphi^*: \mathbb{R} \to \mathbb{R}$</span> is the Legendre transform of <span>$\varphi$</span>, defined as</p><div>\[\varphi^*(z) = \sup_{x \geq 0} xz - \varphi(x).\]</div><p>The functions <span>$f$</span> and <span>$g$</span> are called the <em>dual potentials</em> (in [<a href="optimal_transport.html#SFVTP19-1">SFVTP19</a>], at least). Sinkhorn&#39;s algorithm as implemented in <a href="public_api.html#UnbalancedOptimalTransport.unbalanced_sinkhorn!"><code>unbalanced_sinkhorn!</code></a> computes the optimal dual potentials, namely those which achieve the maximum in the optimization problem above.</p><h2 id="References-1"><a class="docs-heading-anchor" href="#References-1">References</a><a class="docs-heading-anchor-permalink" href="#References-1" title="Permalink"></a></h2><h3 id="SFVTP19-1"><a class="docs-heading-anchor" href="#SFVTP19-1">SFVTP19</a><a class="docs-heading-anchor-permalink" href="#SFVTP19-1" title="Permalink"></a></h3><p>[SFVTP19] Séjourné, T., Feydy, J., Vialard, F.-X., Trouvé, A., Peyré, G., 2019. <em>Sinkhorn Divergences for Unbalanced Optimal Transport</em>. <a href="https://arxiv.org/abs/1910.12958">arXiv:1910.12958</a>.</p><h3 id="Other-references-1"><a class="docs-heading-anchor" href="#Other-references-1">Other references</a><a class="docs-heading-anchor-permalink" href="#Other-references-1" title="Permalink"></a></h3><p>[PC18] Peyré, G., Cuturi, M., 2018. <em>Computational Optimal Transport</em>. <a href="https://arxiv.org/abs/1803.00567">arXiv:1803.00567</a>.</p><p>[Villani09] Villani, C., 2009. <em>Optimal Transport: Old and New</em>, Grundlehren der mathematischen Wissenschaften. Springer-Verlag, Berlin Heidelberg.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="index.html">« Home</a><a class="docs-footer-nextpage" href="public_api.html">Public API »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Friday 17 January 2020 16:44">Friday 17 January 2020</span>. Using Julia version 1.0.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
